<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinkedIn Knowledge Graph Explorer</title>
    
    <!-- PapaParse for CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <!-- D3.js for graph visualization -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
            flex-direction: column;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .header h1 {
            color: #0077b5;
            font-size: 24px;
            font-weight: 600;
        }

        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-box {
            padding: 8px 15px;
            border: 2px solid #ddd;
            border-radius: 20px;
            font-size: 14px;
            width: 250px;
            transition: border-color 0.3s;
        }

        .search-box:focus {
            outline: none;
            border-color: #0077b5;
        }

        .btn {
            padding: 8px 20px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            background: #0077b5;
            color: white;
        }

        .btn:hover {
            background: #005885;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .graph-container {
            flex: 1;
            position: relative;
            background: #1a1a2e;
        }

        #graph {
            width: 100%;
            height: 100%;
        }

        .sidebar {
            width: 350px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            overflow-y: auto;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            display: none;
        }

        .sidebar.active {
            display: block;
        }

        .sidebar h2 {
            color: #0077b5;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .company-filter-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .company-filter-section h3 {
            font-size: 16px;
            color: #495057;
            margin-bottom: 10px;
        }

        .company-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .company-item {
            display: flex;
            align-items: center;
            padding: 8px;
            margin-bottom: 5px;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .company-item:hover {
            background: #e3f2fd;
        }

        .company-item input[type="checkbox"] {
            margin-right: 10px;
            cursor: pointer;
        }

        .company-icon {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: white;
            flex-shrink: 0;
        }

        .company-name {
            flex: 1;
            font-size: 13px;
            color: #212529;
        }

        .company-count {
            font-size: 11px;
            color: #6c757d;
            background: #e9ecef;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .filter-actions {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .filter-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-btn.select-all {
            background: #28a745;
            color: white;
        }

        .filter-btn.select-all:hover {
            background: #218838;
        }

        .filter-btn.clear-all {
            background: #dc3545;
            color: white;
        }

        .filter-btn.clear-all:hover {
            background: #c82333;
        }

        .node-info {
            margin-bottom: 20px;
        }

        .info-item {
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .info-label {
            font-weight: 600;
            color: #495057;
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .info-value {
            color: #212529;
            font-size: 14px;
            word-break: break-word;
        }

        .stats {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .stat-box {
            background: #e3f2fd;
            padding: 10px 15px;
            border-radius: 8px;
            text-align: center;
            flex: 1;
            min-width: 100px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #0077b5;
        }

        .stat-label {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }

        .filter-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e9ecef;
        }

        .filter-group {
            margin-bottom: 15px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
            font-size: 14px;
        }

        .filter-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 2000;
            text-align: center;
        }

        .loading.hidden {
            display: none;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0077b5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 3000;
            display: none;
        }

        .notification.error {
            background: #dc3545;
        }

        .notification.show {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîó LinkedIn Knowledge Graph Explorer</h1>
            <div class="controls">
                <input type="file" id="csvFile" accept=".csv" style="display: none;">
                <button class="btn" onclick="loadCSV()">üìÅ Load CSV</button>
                <button class="btn btn-success" onclick="loadNextBatch()" id="loadMoreBtn" style="display: none;">‚ûï Load More (100)</button>
                <span id="connectionCount" style="background: white; padding: 8px 15px; border-radius: 20px; font-weight: 600; color: #0077b5; display: none;">0 connections</span>
                <input type="text" id="searchBox" class="search-box" placeholder="üîç Search connections..." oninput="handleSearch()">
                <button class="btn btn-secondary" onclick="resetView()">üîÑ Reset View</button>
                <button class="btn btn-secondary" onclick="toggleSidebar()">‚ÑπÔ∏è Info Panel</button>
                <button class="btn btn-success" onclick="exportGraph()">üíæ Export Graph</button>
            </div>
        </div>

        <div class="main-content">
            <div class="graph-container">
                <svg id="graph"></svg>
                <div class="tooltip" id="tooltip"></div>
            </div>
            <div class="sidebar" id="sidebar">
                <h2>Connection Details</h2>
                <div id="nodeInfo">
                    <p style="color: #6c757d; font-size: 14px;">Click on a node to view details</p>
                </div>
                <div class="stats" id="stats" style="display: none;">
                    <div class="stat-box">
                        <div class="stat-value" id="displayedConnections">0</div>
                        <div class="stat-label">Displayed</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="totalConnections">0</div>
                        <div class="stat-label">Total</div>
                    </div>
                </div>
                
                <div class="company-filter-section" id="companyFilterSection" style="display: none;">
                    <h3>üè¢ Filter by Company</h3>
                    <div class="filter-actions">
                        <button class="filter-btn select-all" onclick="selectAllCompanies()">Select All</button>
                        <button class="filter-btn clear-all" onclick="clearAllCompanies()">Clear All</button>
                    </div>
                    <div style="margin: 10px 0; padding: 10px; background: white; border-radius: 5px;">
                        <label style="display: flex; align-items: center; cursor: pointer; font-size: 13px;">
                            <input type="checkbox" id="clusterToggle" onchange="toggleClustering(this.checked)" style="margin-right: 8px;">
                            <span>üîó Enable Company Clustering</span>
                        </label>
                    </div>
                    <div class="company-list" id="companyList"></div>
                </div>
                
                <div class="filter-section">
                    <h2>Filters</h2>
                    <div class="filter-group">
                        <label>Company</label>
                        <input type="text" id="filterCompany" class="filter-input" placeholder="Filter by company..." onkeyup="applyFilters()">
                    </div>
                    <div class="filter-group">
                        <label>Position</label>
                        <input type="text" id="filterPosition" class="filter-input" placeholder="Filter by position..." onkeyup="applyFilters()">
                    </div>
                    <div class="filter-group">
                        <label>Connected Date</label>
                        <input type="text" id="filterDate" class="filter-input" placeholder="Filter by date..." onkeyup="applyFilters()">
                    </div>
                </div>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div id="loadingText">Click "Load CSV" to import your LinkedIn connections</div>
        </div>

        <div class="notification" id="notification"></div>
    </div>

    <script>
        let allData = [];
        let filteredData = [];
        let displayedData = [];
        let simulation;
        let svg, g, link, node, text;
        let selectedNode = null;
        let currentBatch = 0;
        const BATCH_SIZE = 100;
        let isLoading = false;
        let selectedCompanies = new Set();
        let companyColors = {};
        let clusteringEnabled = false;
        
        // Initialize
        document.getElementById('csvFile').addEventListener('change', handleFileSelect);
        
        function toggleClustering(enabled) {
            clusteringEnabled = enabled;
            console.log('Clustering toggled:', enabled);
            
            // Rebuild graph with clustering
            if (displayedData.length > 0) {
                buildGraph(displayedData);
            }
            
            if (enabled) {
                showNotification('Company clustering enabled! Nodes grouped by company.', 'success');
            } else {
                showNotification('Company clustering disabled.', 'success');
            }
        }
        
        function buildCompanyFilter() {
            // Count connections per company
            const companyCounts = {};
            allData.forEach(conn => {
                const company = conn.company || 'Unknown';
                companyCounts[company] = (companyCounts[company] || 0) + 1;
            });
            
            // Sort companies by count (descending)
            const sortedCompanies = Object.entries(companyCounts)
                .sort((a, b) => b[1] - a[1]);
            
            // Generate colors for each company
            const colors = [
                '#0077b5', '#28a745', '#dc3545', '#ffc107', '#17a2b8', 
                '#6f42c1', '#fd7e14', '#20c997', '#e83e8c', '#6c757d',
                '#007bff', '#28a745', '#ffc107', '#dc3545', '#17a2b8'
            ];
            
            sortedCompanies.forEach(([company], index) => {
                companyColors[company] = colors[index % colors.length];
                selectedCompanies.add(company); // All selected by default
            });
            
            // Build HTML
            const companyListHtml = sortedCompanies.map(([company, count]) => {
                const initial = company.charAt(0).toUpperCase();
                const color = companyColors[company];
                
                return `
                    <div class="company-item" onclick="toggleCompany('${escapeHtml(company)}')">
                        <input type="checkbox" 
                               id="company_${escapeHtml(company)}" 
                               checked 
                               onchange="handleCompanyCheckbox('${escapeHtml(company)}', event)">
                        <div class="company-icon" style="background: ${color};">
                            ${initial}
                        </div>
                        <div class="company-name">${escapeHtml(company)}</div>
                        <div class="company-count">${count}</div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('companyList').innerHTML = companyListHtml;
            document.getElementById('companyFilterSection').style.display = 'block';
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function toggleCompany(company) {
            const checkbox = document.getElementById(`company_${company}`);
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
                handleCompanyCheckbox(company, checkbox.checked);
            }
        }
        
        function handleCompanyCheckbox(company, eventOrChecked) {
            // Handle both real events and boolean values
            let isChecked;
            if (typeof eventOrChecked === 'boolean') {
                isChecked = eventOrChecked;
            } else {
                if (eventOrChecked.stopPropagation) {
                    eventOrChecked.stopPropagation();
                }
                isChecked = eventOrChecked.target.checked;
            }
            
            if (isChecked) {
                selectedCompanies.add(company);
            } else {
                selectedCompanies.delete(company);
            }
            
            applyCompanyFilter();
        }
        
        function selectAllCompanies() {
            selectedCompanies.clear();
            Object.keys(companyColors).forEach(company => {
                selectedCompanies.add(company);
                const checkbox = document.getElementById(`company_${company}`);
                if (checkbox) checkbox.checked = true;
            });
            applyCompanyFilter();
        }
        
        function clearAllCompanies() {
            selectedCompanies.clear();
            Object.keys(companyColors).forEach(company => {
                const checkbox = document.getElementById(`company_${company}`);
                if (checkbox) checkbox.checked = false;
            });
            applyCompanyFilter();
        }
        
        function applyCompanyFilter() {
            console.log('=== APPLYING COMPANY FILTER ===');
            console.log('Selected companies:', Array.from(selectedCompanies));
            
            // Filter data based on selected companies
            filteredData = allData.filter(conn => {
                const company = conn.company || 'Unknown';
                return selectedCompanies.has(company);
            });
            
            console.log(`Filtered to ${filteredData.length} connections`);
            
            // Reset to first batch
            currentBatch = 1;
            displayedData = filteredData.slice(0, Math.min(BATCH_SIZE, filteredData.length));
            
            // Rebuild graph
            buildGraph(displayedData);
            updateStats();
            updateLoadMoreButton();
            
            showNotification(`Showing ${filteredData.length} connections from ${selectedCompanies.size} companies`, 'success');
        }
        
        function loadCSV() {
            document.getElementById('csvFile').click();
        }
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                showLoading(true);
                const reader = new FileReader();
                reader.onload = function(e) {
                    parseCSV(e.target.result);
                };
                reader.readAsText(file);
            }
        }
        
        function parseCSV(csvText) {
            Papa.parse(csvText, {
                header: true,
                skipEmptyLines: true,
                dynamicTyping: false,
                transformHeader: function(header) {
                    // Clean up headers - remove BOM and special characters
                    return header.trim().replace(/^\uFEFF/, '');
                },
                complete: function(results) {
                    console.log('Parsed CSV data:', results);
                    console.log('Total rows:', results.data.length);
                    console.log('Headers:', results.meta.fields);
                    console.log('Sample rows:', results.data.slice(0, 3));
                    
                    // Filter out empty rows and map data
                    const filtered = results.data.filter(row => {
                        const firstName = (row['First Name'] || '').trim();
                        return firstName && firstName !== 'Notes:' && firstName.length > 0;
                    });
                    
                    console.log('Filtered rows:', filtered.length);
                    
                    allData = filtered.map((row, index) => {
                        // Clean up special unicode characters from names
                        const firstName = (row['First Name'] || '').trim()
                            .replace(/[\u202a\u202c\u200f\u200e]/g, ''); // Remove direction marks
                        const lastName = (row['Last Name'] || '').trim()
                            .replace(/[\u202a\u202c\u200f\u200e]/g, '');
                        
                        return {
                            id: index,
                            firstName: firstName,
                            lastName: lastName,
                            fullName: `${firstName} ${lastName}`.trim(),
                            company: (row['Company'] || 'Unknown').trim(),
                            position: (row['Position'] || 'Unknown').trim(),
                            email: (row['Email Address'] || '').trim(),
                            url: (row['URL'] || '').trim(),
                            connectedOn: (row['Connected On'] || '').trim()
                        };
                    });
                    
                    console.log('Final data count:', allData.length);
                    console.log('Sample processed data:', allData.slice(0, 3));
                    
                    if (allData.length === 0) {
                        showLoading(false);
                        showNotification('No connections found in CSV. Please check the file format.', 'error');
                        console.error('Available columns:', results.meta.fields);
                        return;
                    }
                    
                    filteredData = [...allData];
                    currentBatch = 0;
                    
                    // Initialize displayedData with only first batch
                    displayedData = filteredData.slice(0, Math.min(BATCH_SIZE, filteredData.length));
                    
                    console.log(`Initial load: displaying ${displayedData.length} of ${filteredData.length} total connections`);
                    
                    // Build company filter list
                    buildCompanyFilter();
                    
                    // Build graph with only the first batch
                    buildGraph(displayedData);
                    currentBatch = 1; // Set to 1 since we've loaded the first batch
                    
                    showLoading(false);
                    showNotification(`Loaded ${displayedData.length} of ${allData.length} connections. Click "Load More" to see more!`, 'success');
                    updateStats();
                },
                error: function(error) {
                    showLoading(false);
                    showNotification('Error parsing CSV: ' + error.message, 'error');
                    console.error('Parse error:', error);
                }
            });
        }
        
        function loadNextBatch() {
            if (isLoading) return;
            
            const start = currentBatch * BATCH_SIZE;
            const end = Math.min(start + BATCH_SIZE, filteredData.length);
            
            if (start >= filteredData.length) {
                return; // All data loaded
            }
            
            isLoading = true;
            
            // Only get the data up to the current end point
            displayedData = filteredData.slice(0, end);
            
            console.log(`Loading batch ${currentBatch + 1}: showing ${displayedData.length} of ${filteredData.length} total`);
            
            // Rebuild graph with current displayed data
            buildGraph(displayedData);
            currentBatch++;
            isLoading = false;
            
            updateStats();
            updateLoadMoreButton();
            
            if (end < filteredData.length) {
                showNotification(`Showing ${end} of ${filteredData.length} connections. Click "Load More" to see more!`, 'success');
            } else {
                showNotification(`All ${filteredData.length} connections loaded!`, 'success');
            }
        }
        
        function buildGraph(data) {
            console.log(`=== BUILD GRAPH CALLED ===`);
            console.log(`Data parameter length: ${data.length}`);
            console.log(`displayedData length: ${displayedData.length}`);
            console.log(`filteredData length: ${filteredData.length}`);
            console.log(`allData length: ${allData.length}`);
            console.log(`Clustering enabled: ${clusteringEnabled}`);
            
            const width = document.getElementById('graph').clientWidth;
            const height = document.getElementById('graph').clientHeight;
            
            // Clear existing graph
            d3.select('#graph').selectAll('*').remove();
            
            // Setup SVG
            svg = d3.select('#graph')
                .attr('width', width)
                .attr('height', height);
            
            // Add zoom behavior
            const zoom = d3.zoom()
                .scaleExtent([0.1, 4])
                .on('zoom', (event) => {
                    g.attr('transform', event.transform);
                });
            
            svg.call(zoom);
            
            g = svg.append('g');
            
            if (clusteringEnabled) {
                // Use circle packing for clustering
                buildPackedGraph(data, width, height);
            } else {
                // Use force simulation for non-clustered view
                buildForceGraph(data, width, height);
            }
        }
        
        function buildPackedGraph(data, width, height) {
            // Group data by company
            const companyGroups = d3.group(data, d => d.company || 'Unknown');
            
            // Create hierarchical data structure
            const hierarchyData = {
                name: 'You',
                children: Array.from(companyGroups, ([company, connections]) => ({
                    name: company,
                    children: connections.map(conn => ({
                        name: conn.fullName,
                        id: conn.id,
                        data: conn,
                        value: 1
                    }))
                }))
            };
            
            // Create pack layout
            const pack = d3.pack()
                .size([width * 0.95, height * 0.95])
                .padding(3);
            
            // Create hierarchy and calculate layout
            const root = d3.hierarchy(hierarchyData)
                .sum(d => d.value)
                .sort((a, b) => b.value - a.value);
            
            pack(root);
            
            // Center the layout
            const nodes = root.descendants();
            nodes.forEach(d => {
                d.x += width * 0.025;
                d.y += height * 0.025;
            });
            
            // Draw company circles (level 1)
            const companyCircles = g.selectAll('.company-circle')
                .data(root.children || [])
                .join('circle')
                .attr('class', 'company-circle')
                .attr('cx', d => d.x)
                .attr('cy', d => d.y)
                .attr('r', d => d.r)
                .attr('fill', 'none')
                .attr('stroke', d => companyColors[d.data.name] || '#666')
                .attr('stroke-width', 3)
                .attr('stroke-opacity', 0.5);
            
            // Draw company labels
            const companyLabels = g.selectAll('.company-label')
                .data(root.children || [])
                .join('text')
                .attr('class', 'company-label')
                .attr('x', d => d.x)
                .attr('y', d => d.y - d.r - 5)
                .attr('text-anchor', 'middle')
                .attr('font-size', 14)
                .attr('font-weight', 'bold')
                .attr('fill', d => companyColors[d.data.name] || '#fff')
                .text(d => d.data.name);
            
            // Draw connection nodes (level 2 - leaf nodes)
            const leafNodes = root.descendants().filter(d => d.depth === 2);
            
            node = g.selectAll('.connection-node')
                .data(leafNodes)
                .join('circle')
                .attr('class', 'connection-node')
                .attr('cx', d => d.x)
                .attr('cy', d => d.y)
                .attr('r', 6)
                .attr('fill', d => {
                    const company = d.parent?.data.name || 'Unknown';
                    return companyColors[company] || '#28a745';
                })
                .attr('stroke', '#fff')
                .attr('stroke-width', 2)
                .style('cursor', 'pointer')
                .on('click', (event, d) => handleNodeClick({ 
                    id: d.data.id, 
                    name: d.data.name, 
                    type: 'connection',
                    data: d.data.data 
                }))
                .on('mouseover', (event, d) => showTooltip(event, { name: d.data.name }))
                .on('mouseout', hideTooltip);
            
            // Draw labels for connection nodes
            text = g.selectAll('.connection-label')
                .data(leafNodes)
                .join('text')
                .attr('class', 'connection-label')
                .attr('x', d => d.x)
                .attr('y', d => d.y - 10)
                .attr('text-anchor', 'middle')
                .attr('font-size', 8)
                .attr('fill', '#fff')
                .style('pointer-events', 'none')
                .text(d => d.data.name.length > 15 ? d.data.name.substring(0, 15) + '...' : d.data.name);
            
            // Draw central "You" node
            g.append('circle')
                .attr('cx', root.x)
                .attr('cy', root.y)
                .attr('r', 20)
                .attr('fill', '#0077b5')
                .attr('stroke', '#fff')
                .attr('stroke-width', 3);
            
            g.append('text')
                .attr('x', root.x)
                .attr('y', root.y)
                .attr('text-anchor', 'middle')
                .attr('dy', '0.35em')
                .attr('font-size', 14)
                .attr('font-weight', 'bold')
                .attr('fill', '#fff')
                .text('You');
        }
        
        function buildForceGraph(data, width, height) {
            // Create nodes and links - should only use the data passed in
            const nodes = [
                { id: 'central', name: 'You', type: 'central' },
                ...data.map(d => ({ 
                    id: d.id, 
                    name: d.fullName,
                    type: 'connection',
                    data: d,
                    company: d.company || 'Unknown'
                }))
            ];
            
            console.log(`Total nodes created (including central): ${nodes.length}`);
            console.log(`Connection nodes: ${nodes.length - 1}`);
            
            const links = data.map(d => ({
                source: 'central',
                target: d.id
            }));
            
            // Create force simulation
            simulation = d3.forceSimulation(nodes)
                .force('link', d3.forceLink(links).id(d => d.id).distance(100))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(30));
            
            // Create links
            link = g.append('g')
                .selectAll('line')
                .data(links)
                .join('line')
                .attr('stroke', '#999')
                .attr('stroke-opacity', 0.6)
                .attr('stroke-width', 1);
            
            // Create nodes
            node = g.append('g')
                .selectAll('circle')
                .data(nodes)
                .join('circle')
                .attr('r', d => d.type === 'central' ? 15 : 8)
                .attr('fill', d => {
                    if (d.type === 'central') return '#0077b5';
                    const company = d.data?.company || 'Unknown';
                    return companyColors[company] || '#28a745';
                })
                .attr('stroke', '#fff')
                .attr('stroke-width', 2)
                .style('cursor', 'pointer')
                .call(drag(simulation))
                .on('click', (event, d) => handleNodeClick(d))
                .on('mouseover', (event, d) => showTooltip(event, d))
                .on('mouseout', hideTooltip);
            
            // Create labels
            text = g.append('g')
                .selectAll('text')
                .data(nodes)
                .join('text')
                .text(d => d.name.length > 15 ? d.name.substring(0, 15) + '...' : d.name)
                .attr('font-size', d => d.type === 'central' ? 14 : 10)
                .attr('dx', 12)
                .attr('dy', 4)
                .attr('fill', '#fff')
                .style('pointer-events', 'none');
            
            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);
                
                node
                    .attr('cx', d => d.x)
                    .attr('cy', d => d.y);
                
                text
                    .attr('x', d => d.x)
                    .attr('y', d => d.y);
            });
        }
        
        function drag(simulation) {
            function dragstarted(event) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                event.subject.fx = event.subject.x;
                event.subject.fy = event.subject.y;
            }
            
            function dragged(event) {
                event.subject.fx = event.x;
                event.subject.fy = event.y;
            }
            
            function dragended(event) {
                if (!event.active) simulation.alphaTarget(0);
                event.subject.fx = null;
                event.subject.fy = null;
            }
            
            return d3.drag()
                .on('start', dragstarted)
                .on('drag', dragged)
                .on('end', dragended);
        }
        
        function handleNodeClick(nodeData) {
            selectedNode = nodeData;
            
            // Update node colors
            node.attr('fill', d => {
                if (d.id === nodeData.id) return '#ffc107';
                if (d.type === 'central') return '#0077b5';
                const company = d.data?.company || 'Unknown';
                return companyColors[company] || '#28a745';
            });
            
            // Show sidebar
            document.getElementById('sidebar').classList.add('active');
            
            if (nodeData.type === 'central') {
                document.getElementById('nodeInfo').innerHTML = `
                    <div class="node-info">
                        <div class="info-item">
                            <div class="info-label">Name</div>
                            <div class="info-value">You (Central Node)</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Total Connections</div>
                            <div class="info-value">${allData.length}</div>
                        </div>
                    </div>
                `;
            } else {
                const data = nodeData.data;
                document.getElementById('nodeInfo').innerHTML = `
                    <div class="node-info">
                        <div class="info-item">
                            <div class="info-label">Name</div>
                            <div class="info-value">${data.fullName}</div>
                        </div>
                        ${data.company ? `
                        <div class="info-item">
                            <div class="info-label">Company</div>
                            <div class="info-value">${data.company}</div>
                        </div>
                        ` : ''}
                        ${data.position ? `
                        <div class="info-item">
                            <div class="info-label">Position</div>
                            <div class="info-value">${data.position}</div>
                        </div>
                        ` : ''}
                        ${data.email ? `
                        <div class="info-item">
                            <div class="info-label">Email</div>
                            <div class="info-value">${data.email}</div>
                        </div>
                        ` : ''}
                        ${data.url ? `
                        <div class="info-item">
                            <div class="info-label">LinkedIn Profile</div>
                            <div class="info-value">
                                <a href="${data.url}" target="_blank" style="color: #0077b5; text-decoration: none;">
                                    View Profile
                                </a>
                            </div>
                        </div>
                        ` : ''}
                        ${data.connectedOn ? `
                        <div class="info-item">
                            <div class="info-label">Connected On</div>
                            <div class="info-value">${data.connectedOn}</div>
                        </div>
                        ` : ''}
                    </div>
                `;
            }
        }
        
        function showTooltip(event, d) {
            const tooltip = document.getElementById('tooltip');
            tooltip.style.display = 'block';
            tooltip.style.left = (event.pageX + 10) + 'px';
            tooltip.style.top = (event.pageY - 10) + 'px';
            tooltip.textContent = d.name;
        }
        
        function hideTooltip() {
            document.getElementById('tooltip').style.display = 'none';
        }
        
        function handleSearch() {
            const query = document.getElementById('searchBox').value.toLowerCase().trim();
            applyFilters();
        }
        
        function applyFilters() {
            console.log('=== APPLY FILTERS CALLED ===');
            const searchQuery = document.getElementById('searchBox').value.toLowerCase().trim();
            const companyFilter = document.getElementById('filterCompany').value.toLowerCase().trim();
            const positionFilter = document.getElementById('filterPosition').value.toLowerCase().trim();
            const dateFilter = document.getElementById('filterDate').value.toLowerCase().trim();
            
            console.log('Filters:', { searchQuery, companyFilter, positionFilter, dateFilter });
            
            filteredData = allData.filter(d => {
                const matchSearch = !searchQuery || 
                    d.fullName.toLowerCase().includes(searchQuery) ||
                    d.company.toLowerCase().includes(searchQuery) ||
                    d.position.toLowerCase().includes(searchQuery) ||
                    d.email.toLowerCase().includes(searchQuery);
                
                const matchCompany = !companyFilter || d.company.toLowerCase().includes(companyFilter);
                const matchPosition = !positionFilter || d.position.toLowerCase().includes(positionFilter);
                const matchDate = !dateFilter || d.connectedOn.toLowerCase().includes(dateFilter);
                
                return matchSearch && matchCompany && matchPosition && matchDate;
            });
            
            if (allData.length > 0) {
                currentBatch = 1;
                displayedData = filteredData.slice(0, Math.min(BATCH_SIZE, filteredData.length));
                console.log(`After filter: displaying ${displayedData.length} of ${filteredData.length}`);
                buildGraph(displayedData);
                updateStats();
                updateLoadMoreButton();
            }
        }
        
        function resetView() {
            document.getElementById('searchBox').value = '';
            document.getElementById('filterCompany').value = '';
            document.getElementById('filterPosition').value = '';
            document.getElementById('filterDate').value = '';
            filteredData = [...allData];
            currentBatch = 0;
            if (allData.length > 0) {
                displayedData = filteredData.slice(0, Math.min(BATCH_SIZE, filteredData.length));
                buildGraph(displayedData);
                updateStats();
                updateLoadMoreButton();
            }
            selectedNode = null;
        }
        
        function updateLoadMoreButton() {
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            const remaining = filteredData.length - displayedData.length;
            
            if (remaining > 0) {
                loadMoreBtn.style.display = 'inline-block';
                loadMoreBtn.textContent = `‚ûï Load More (${Math.min(BATCH_SIZE, remaining)})`;
            } else {
                loadMoreBtn.style.display = 'none';
            }
        }
        
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }
        
        function exportGraph() {
            const exportData = {
                connections: allData,
                stats: {
                    total: allData.length,
                    filtered: filteredData.length
                },
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'linkedin_connections_export.json';
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('Graph exported successfully!', 'success');
        }
        
        function updateStats() {
            document.getElementById('stats').style.display = 'flex';
            document.getElementById('totalConnections').textContent = filteredData.length;
            document.getElementById('displayedConnections').textContent = displayedData.length;
            
            // Update header count
            const countEl = document.getElementById('connectionCount');
            countEl.style.display = 'inline-block';
            countEl.textContent = `${displayedData.length} / ${filteredData.length} connections`;
            
            updateLoadMoreButton();
        }
        
        function showLoading(show) {
            const loading = document.getElementById('loading');
            if (show) {
                loading.classList.remove('hidden');
                document.getElementById('loadingText').textContent = 'Loading connections...';
            } else {
                loading.classList.add('hidden');
            }
        }
        
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // Handle window resize
        let resizeTimeout;
        window.addEventListener('resize', () => {
            console.log('=== WINDOW RESIZE TRIGGERED ===');
            if (allData.length > 0) {
                // Debounce resize to avoid multiple calls
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    console.log('Rebuilding graph after resize with displayedData:', displayedData.length);
                    buildGraph(displayedData);
                }, 250);
            }
        });
    </script>
</body>
</html>
